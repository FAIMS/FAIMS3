

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> sync/databases.ts</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="RecordDraftState.html">RecordDraftState</a></li></ul><h3>Interfaces</h3><ul><li><a href="ProjectObject.html">ProjectObject</a></li><li><a href="ProjectRevisionListing.html">ProjectRevisionListing</a></li><li><a href="SplitRecordID.html">SplitRecordID</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ConnectionInfo_create_pouch">ConnectionInfo_create_pouch</a></li><li><a href="global.html#LoginButton">LoginButton</a></li><li><a href="global.html#THROTTLE_TIME">THROTTLE_TIME</a></li><li><a href="global.html#active_db">active_db</a></li><li><a href="global.html#all_meta_synced">all_meta_synced</a></li><li><a href="global.html#all_projects_updated">all_projects_updated</a></li><li><a href="global.html#constantArgs">constantArgs</a></li><li><a href="global.html#constantArgsShared">constantArgsShared</a></li><li><a href="global.html#constantArgsSplit">constantArgsSplit</a></li><li><a href="global.html#createdListings">createdListings</a></li><li><a href="global.html#createdProjects">createdProjects</a></li><li><a href="global.html#data_dbs">data_dbs</a></li><li><a href="global.html#default_changes_opts">default_changes_opts</a></li><li><a href="global.html#deleteStagedData">deleteStagedData</a></li><li><a href="global.html#directory_db">directory_db</a></li><li><a href="global.html#ensure_local_db">ensure_local_db</a></li><li><a href="global.html#ensure_synced_db">ensure_synced_db</a></li><li><a href="global.html#firstDefinedFromList">firstDefinedFromList</a></li><li><a href="global.html#getDataDB">getDataDB</a></li><li><a href="global.html#getProjectDB">getProjectDB</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initialize_state">initialize_state</a></li><li><a href="global.html#listDraftMetadata">listDraftMetadata</a></li><li><a href="global.html#listDraftsEncoded">listDraftsEncoded</a></li><li><a href="global.html#listRecordMetadata">listRecordMetadata</a></li><li><a href="global.html#listenDataDB">listenDataDB</a></li><li><a href="global.html#listenProject">listenProject</a></li><li><a href="global.html#listenProjectDB">listenProjectDB</a></li><li><a href="global.html#listing_projects_synced">listing_projects_synced</a></li><li><a href="global.html#listings_updated">listings_updated</a></li><li><a href="global.html#local_auth_db">local_auth_db</a></li><li><a href="global.html#local_state_db">local_state_db</a></li><li><a href="global.html#metadata_dbs">metadata_dbs</a></li><li><a href="global.html#newStagedData">newStagedData</a></li><li><a href="global.html#process_listing">process_listing</a></li><li><a href="global.html#process_project">process_project</a></li><li><a href="global.html#projects_dbs">projects_dbs</a></li><li><a href="global.html#projects_meta_synced">projects_meta_synced</a></li><li><a href="global.html#reprocess_listing">reprocess_listing</a></li><li><a href="global.html#resolve_record_id">resolve_record_id</a></li><li><a href="global.html#setLocalConnection">setLocalConnection</a></li><li><a href="global.html#setStagedData">setStagedData</a></li><li><a href="global.html#update_listing">update_listing</a></li><li><a href="global.html#update_project">update_project</a></li><li><a href="global.html#useEventedPromise">useEventedPromise</a></li><li><a href="global.html#waitForStateOnce">waitForStateOnce</a></li></ul></div><div class="category"><h2>Database</h2><h3>Modules</h3><ul><li><a href="module-data_storage.html">data_storage</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>sync/databases.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2021, 2022 Macquarie University
 *
 * Licensed under the Apache License Version 2.0 (the, "License");
 * you may not use, this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing software
 * distributed under the License is distributed on an "AS IS" BASIS
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND either express or implied.
 * See, the License, for the specific language governing permissions and
 * limitations under the License.
 *
 * Filename: index.ts
 * Description:
 *   TODO
 */

import PouchDB from 'pouchdb';
import {
  DIRECTORY_PROTOCOL,
  DIRECTORY_HOST,
  DIRECTORY_PORT,
  POUCH_BATCH_SIZE,
  POUCH_BATCHES_LIMIT,
} from '../buildconfig';
import {
  ActiveDoc,
  ConnectionInfo,
  ListingsObject,
  ProjectMetaObject,
  ProjectDataObject,
  ProjectObject,
  LocalAuthDoc,
  NonNullListingsObject,
} from '../datamodel/database';
import {logError} from '../logging';
import {
  ConnectionInfo_create_pouch,
  local_pouch_options,
  materializeConnectionInfo,
} from './connection';
import {draft_db} from './draft-storage';

export const DB_TIMEOUT = 2000;
export const DEFAULT_LISTING_ID = 'default';
export const POUCH_SEPARATOR = '_';
export const directory_connection_info: ConnectionInfo = {
  proto: DIRECTORY_PROTOCOL,
  host: DIRECTORY_HOST,
  port: DIRECTORY_PORT,
  db_name: 'directory',
};

export type ExistingActiveDoc = PouchDB.Core.ExistingDocument&lt;ActiveDoc>;
export type ExistingListings = PouchDB.Core.ExistingDocument&lt;ListingsObject>;

export interface LocalDB&lt;Content extends {}> {
  local: PouchDB.Database&lt;Content>;
  changes: PouchDB.Core.Changes&lt;Content>;
  is_sync: boolean;
  is_sync_attachments: boolean;
  remote: null | LocalDBRemote&lt;Content>;
}

export interface LocalDBRemote&lt;Content extends {}> {
  db: PouchDB.Database&lt;Content>;
  connection:
    | PouchDB.Replication.Replication&lt;Content>
    | PouchDB.Replication.Sync&lt;Content>
    | null;
  info: ConnectionInfo;
  options: DBReplicateOptions;
}

export interface LocalDBList&lt;Content extends {}> {
  [key: string]: LocalDB&lt;Content>;
}

type DBReplicateOptions =
  | PouchDB.Replication.ReplicateOptions
  | {
      pull: PouchDB.Replication.ReplicateOptions;
      push: PouchDB.Replication.ReplicateOptions;
    };

/**
 * Each database has a changes stream.
 * This is the template for which the changes stream is listened to
 * Some databases might use options added to this like:
 *  {...default_changes_opts, filter:'abc'}
 * If they want to, for example, restrict to only listings in the active DB.
 */
export const default_changes_opts: PouchDB.Core.ChangesOptions &amp;
  PouchDB.Core.AllDocsOptions = {
  live: true,
  since: 'now',
  timeout: DB_TIMEOUT,
  include_docs: true,
  conflicts: true,
  attachments: true,
};

const directory_db_pouch = new PouchDB&lt;ListingsObject>(
  'directory',
  local_pouch_options
);
/**
 * Directory: All (public) Faims instances
 */
export const directory_db: LocalDB&lt;ListingsObject> = {
  local: directory_db_pouch,
  changes: directory_db_pouch.changes({...default_changes_opts, since: 'now'}),
  remote: null,
  is_sync: true,
  is_sync_attachments: false,
};

/**
 * Active: A local (NOT synced) list of:
 *   {_id, username, password, project_id, listing_id}
 *   For each project the current device is part of (so this is keyed by listing id + project id),
 *   * listing_id: A couchdb instance object's id (from "directory" db)
 *   * project_id: A project id (from the project_db in the couchdb instance object.)
 *   * authentication mechanism used (id of a doc in the auth_db)
 */
export const active_db = new PouchDB&lt;ActiveDoc>('active', local_pouch_options);

/**
 * This contains any local app state we want to keep across sessions
 */
export const local_state_db = new PouchDB('local_state', local_pouch_options);

/**
 * Login tokens for each FAIMS Cluster that needs it
 */
export const local_auth_db = new PouchDB&lt;LocalAuthDoc>(
  'local_auth',
  local_pouch_options
);

/**
 * Each listing has a Projects database and Users DBs
 */
export const projects_dbs: LocalDBList&lt;ProjectObject> = {};

/**
 * Per-[active]-project project data:
 * Contain in these databases (indexed by the active_db id's)
 * is project data.
 */
export const data_dbs: LocalDBList&lt;ProjectDataObject> = {};

/**
 * Synced from the project meta-database for each active project,
 * This has the metadata describing a database. Project Schemas,
 * GUI Models, and a People database.
 */
export const metadata_dbs: LocalDBList&lt;ProjectMetaObject> = {};

let default_instance: null | NonNullListingsObject = null; //Set to directory_db.get(DEFAULT_LISTING_ID) by get_default_instance

export async function get_default_instance(): Promise&lt;NonNullListingsObject> {
  if (default_instance === null) {
    const possibly_corrupted_instance = await directory_db.local.get(
      DEFAULT_LISTING_ID
    );
    default_instance = {
      _id: possibly_corrupted_instance._id,
      name: possibly_corrupted_instance.name,
      description: possibly_corrupted_instance.description,
      projects_db: materializeConnectionInfo(
        directory_connection_info,
        possibly_corrupted_instance.projects_db
      ),
    };
  }
  return default_instance;
}

let default_projects_db: null | ConnectionInfo = null;

export async function get_base_connection_info(
  listing_object: ListingsObject
): Promise&lt;ConnectionInfo> {
  if (default_projects_db === null) {
    try {
      // Normal case of a single DEFAULT listing in the directory
      const possibly_corrupted_instance = await directory_db.local.get(
        DEFAULT_LISTING_ID
      );
      return (default_projects_db = materializeConnectionInfo(
        directory_connection_info,
        possibly_corrupted_instance.projects_db
      ));
    } catch (err: any) {
      // Missing when directory_db has NOTHING in it
      // i.e. current FAIMS app doesn't have a directory
      // this is usually because it's the server, not the app.
      if (err.message !== 'missing') {
        // Other DB error
        throw err;
      }

      const nullExcept = &lt;T>(val: T | undefined | null, err: any): T => {
        if (val === null || val === undefined) {
          throw err;
        }
        return val;
      };

      // If running in server mode
      // the listings object MUST have all the connection properties
      return {
        proto: nullExcept(
          listing_object.projects_db?.proto,
          'Server misconfigured: Missing proto'
        ),
        host: nullExcept(
          listing_object.projects_db?.host,
          'Server misconfigured: Missing host'
        ),
        port: nullExcept(
          listing_object.projects_db?.port,
          'Server misconfigured: Missing port'
        ),
        lan: listing_object.projects_db?.lan,
        db_name: nullExcept(
          listing_object.projects_db?.db_name,
          'Server misconfigured: Missing db_name'
        ),
        auth: listing_object.projects_db?.auth,
      };
    }
  }
  return default_projects_db;
}

/**
 * @param prefix Name to use to run new PouchDB(prefix + POUCH_SEPARATOR + id), objects of the same type have the same prefix
 * @param local_db_id id is per-object of type, to discriminate between them. i.e. a project ID
 * @param global_dbs projects_db
 * @returns Flag if newly created =true, already existing=false &amp; The local DB
 */
export function ensure_local_db&lt;Content extends {}>(
  prefix: string,
  local_db_id: string,
  start_sync: boolean,
  global_dbs: LocalDBList&lt;Content>,
  start_sync_attachments: boolean
): [boolean, LocalDB&lt;Content>] {
  if (global_dbs[local_db_id]) {
    global_dbs[local_db_id].is_sync = start_sync;
    return [false, global_dbs[local_db_id]];
  } else {
    const db = new PouchDB&lt;Content>(
      prefix + POUCH_SEPARATOR + local_db_id,
      local_pouch_options
    );
    return [
      true,
      (global_dbs[local_db_id] = {
        local: db,
        changes: db.changes(default_changes_opts),
        is_sync: start_sync,
        is_sync_attachments: start_sync_attachments,
        remote: null,
      }),
    ];
  }
}

/**
 * @param local_db_id id is per-object of type, to discriminate between them. i.e. a project ID
 * @param global_dbs projects_db
 * @param connection_info Info to use to connect to remote
 * @param options PouchDB options. Defaults to live: true, retry: true.
 *                if options.sync is defined, then this turns into ensuring the DB
 *                is pushing to the remote as well as pulling.
 * @returns Flag if newly created =true, already existing=false &amp; The local DB &amp; remote
 */
export function ensure_synced_db&lt;Content extends {}>(
  local_db_id: string,
  connection_info: ConnectionInfo | null,
  global_dbs: LocalDBList&lt;Content>,
  options: DBReplicateOptions = {}
): [boolean, LocalDB&lt;Content>] {
  if (global_dbs[local_db_id] === undefined) {
    throw 'Logic error: ensure_local_db must be called before this code';
  }

  // Already connected/connecting, or local-only database
  if (
    global_dbs[local_db_id].remote !== null &amp;&amp;
    JSON.stringify(global_dbs[local_db_id].remote!.info) ===
      JSON.stringify(connection_info) &amp;&amp;
    JSON.stringify(global_dbs[local_db_id].remote!.options) ===
      JSON.stringify(options)
  ) {
    return [
      false,
      {
        ...global_dbs[local_db_id],
        remote: global_dbs[local_db_id].remote!,
      },
    ];
  }

  // Special case for local-only projects
  if (connection_info === null) {
    return [false, global_dbs[local_db_id]];
  }

  const db_info = (global_dbs[local_db_id] = {
    ...global_dbs[local_db_id],
    remote: {
      db: ConnectionInfo_create_pouch(connection_info),
      connection: null, //Connection initialized in setLocalConnection
      info: connection_info,
      options: options,
    },
  });

  setLocalConnection(db_info);
  return [true, db_info];
}

/**
 * If the given remote DB is not synced, starts syncing, and visa versa.
 * db_info.remote.{connection, handler} are modified based on what's in
 * db_info.is_sync, db_info.remote.info, db_info.remote.create_handler.
 *
 * This does NOT ensure that the existing connection info (URL, port, proto)
 * matches anything. that's left to ensure_synced_db
 *
 * @param db_info info to use to create a DB connection:
 *                Remote connection info, is_sync, the local DB to sync with,
 */
export function setLocalConnection&lt;Content extends {}>(
  db_info: LocalDB&lt;Content> &amp; {remote: LocalDBRemote&lt;Content>}
) {
  const options = db_info.remote.options;
  console.debug('Setting local connection:', db_info);

  if (db_info.is_sync) {
    if (db_info.remote.connection !== null) {
      // Stop an existing connection
      db_info.remote.connection.cancel();
      db_info.remote.connection = null;
      console.debug('Removed sync for', db_info);
    }
    // Start a new connection
    const push_too = (options as {push?: unknown}).push !== undefined;
    let connection:
      | PouchDB.Replication.Replication&lt;Content>
      | PouchDB.Replication.Sync&lt;Content>;

    const pull_filter = db_info.is_sync_attachments
      ? {}
      : {filter: '_view', view: 'attachment_filter/attachment_filter'};

    if (push_too) {
      const options_sync = options as PouchDB.Replication.SyncOptions;
      console.debug(
        'Pushing and pulling from',
        db_info,
        options_sync.push,
        options_sync.pull,
        pull_filter
      );
      connection = PouchDB.sync(db_info.local, db_info.remote.db, {
        push: {
          live: true,
          retry: true,
          checkpoint: 'source',
          batch_size: POUCH_BATCH_SIZE,
          batches_limit: POUCH_BATCHES_LIMIT,
          ...options_sync.push,
        },
        pull: {
          live: true,
          retry: true,
          checkpoint: 'target',
          batch_size: POUCH_BATCH_SIZE,
          batches_limit: POUCH_BATCHES_LIMIT,
          ...pull_filter,
          ...(options_sync.pull || {}),
        },
      });
    } else {
      console.debug('Pulling only from', db_info, options);
      connection = PouchDB.replicate(db_info.remote.db, db_info.local, {
        live: true,
        retry: true,
        checkpoint: 'target',
        ...options,
      });
    }

    db_info.remote.connection = connection;
    console.debug('Added sync for', db_info);
  } else if (!db_info.is_sync &amp;&amp; db_info.remote.connection !== null) {
    // Stop an existing connection
    db_info.remote.connection.cancel();
    db_info.remote.connection = null;
    console.debug('Removed sync for', db_info);
  } else {
    logError(`Sync is still off ${db_info}`);
  }
}

async function delete_synced_db(name: string, db: LocalDB&lt;any>) {
  try {
    console.debug(await db.remote?.db.close());
  } catch (err) {
    logError(err);
  }
  try {
    console.debug(await db.local.destroy());
    console.debug('Removed local db', name);
  } catch (err) {
    logError(err);
  }
}

async function delete_synced_dbs(db_list: LocalDBList&lt;any>) {
  for (const name in db_list) {
    console.debug('Deleting', name);
    await delete_synced_db(name, db_list[name]);
    delete db_list['name'];
  }
}

export async function wipe_all_pouch_databases() {
  const local_only_dbs_to_wipe = [
    active_db,
    local_state_db,
    draft_db,
    local_auth_db,
  ];
  await delete_synced_dbs(data_dbs);
  await delete_synced_dbs(metadata_dbs);
  await delete_synced_dbs(projects_dbs);
  await delete_synced_db('directory', directory_db);
  for (const db of local_only_dbs_to_wipe) {
    try {
      console.debug(await db.destroy());
    } catch (err) {
      logError(err);
    }
  }
  // TODO: work out how best to recreate the databases, currently using a
  // redirect and having FAIMS reinitialise seems to be the best
  console.debug('Deleted dbs');
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
